<script type="text/javascript" src="./js/openfb.js"></script>

<script type="text/javascript">
(function(root) {
  'use strict';

  var _fb = null;

  Polymer({
    is: 'xin-auth-facebook',

    attached: function() {
      Polymer.dom(this).parentNode.addAdapter('facebook', this);
    },

    detached: function() {
      Polymer.dom(this).parentNode.removeAdapter('facebook');
    },

    properties: {
      appId: String,

      scope: {
        type: String,
        value: 'email'
      }
    },

    _fb: function() {
      if (!_fb) {
        var fbOptions = {
          appId: this.appId,
          scope: this.scope,
        };

        if (this.parentElement.authUrl) {
          fbOptions.loginURL = this.parentElement.authUrl + '/login?mode=facebook';
        }

        openFB.init(fbOptions);
        _fb = openFB;
      }

      return _fb;
    },

    login: function() {
      return new Promise(function(resolve, reject) {
        this._fb().login(function(response) {
          if(response.status === 'connected') {
            this._get('/me', {
                fields: 'id,name,email'
              })
              .then(function(me) {
                return {
                  id: me.id,
                  type: me.type,
                  ref_token: response.authResponse.accessToken,
                };
              })
              .then(resolve, reject);
          } else {
            reject(response.error);
          }
        }.bind(this), {
          scope: this.scope
        });
      }.bind(this));
    },

    _get: function(path, params) {
      return new Promise(function(resolve, reject) {
        this._fb().api({
          method: 'GET',
          path: path,
          params: params || {},
          success: resolve,
          error: reject
        });
      }.bind(this));
    }
  });
})(this);
</script>